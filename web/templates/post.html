<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link rel="stylesheet" href="../static/reset.css">
        <link rel="stylesheet" href="../static/style.css">
        <title>Paint page</title>
    </head>

   <body>
   <div id="wrap">
       <!---- ê·¸ë¦¼íŒ ---->
       <!--- ì¼ê¸° ë‚´ìš© ì˜ì—­ --->
       <form name="form" id="form" ><!--action="/diary" method="POST" onsubmit="checkForm()";-->
           <div class="floatL">
               <canvas id="jsCanvas" class="canvas"></canvas>
               <div class="controls">
               <div class="controls_range">
                   <input type="range" id="jsRange" min="0.1" max="5.0" value="2.5" step="0.1"/>
               </div>
               <div class="controls_btns">
                   <button id="jsMode">ì§€ìš°ê¸°</button>
                   <button id="jsSave">ê·¸ë¦¼ ì €ì¥</button>
               </div>
               <div class="controls_colors" id="jsColors">
                   <div class="controls_color jsColor" style="background-color: #2c2c2c;"></div>
                   <div class="controls_color jsColor" style="background-color: white;"></div>
                   <div class="controls_color jsColor" style="background-color: #FF3B30;"></div>
                   <div class="controls_color jsColor" style="background-color: #ff9500;"></div>
                   <div class="controls_color jsColor" style="background-color: #4cd963;"></div>
                   <div class="controls_color jsColor" style="background-color: #5ac8fa;"></div>
                   <div class="controls_color jsColor" style="background-color: #0579ff;"></div>
                   <div class="controls_color jsColor" style="background-color: #5856d6;"></div>
               </div>
           </div>
           </div>

            <!-- ì œëª© -->
           <div class="floatR">
               <div>
                   <!-- ì œëª© -->
                   <input type="text" name="title" id="title" placeholder="ì œëª© (ìµœëŒ€ 17ê¸€ì)" maxLength="17">
                   <!--ì˜¤ëŠ˜ ë‚ ì§œ : ë³€ìˆ˜ê°€ì ¸ì˜¤ê¸°, í—ˆìš©í•˜ëŠ” ê°€ì¥ ëŠ¦ì€ë‚ ì§œ, í—ˆìš©í•˜ëŠ” ê°€ì¥ ì´ë¥¸ ë‚ ì§œ-->
                   <input type="date" id="day" name="trip-start">
                   <!--value="2018-11-10" min="2018-01-01" max="2018-12-31"-->
                   <!-- ë‚´ìš© -->
                   <textarea name="ë‚´ìš©" id="texts" placeholder="ìµœëŒ€ 70ê¸€ìê¹Œì§€ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤" maxLength="70"></textarea>
                   <!-- ë‚ ì”¨ -->
                   <select name="ë‚ ì”¨" id="weather">
                       <option value="ğŸŒ">ë§‘ìŒ ğŸŒ</option>
                       <option value="â˜">êµ¬ë¦„ â˜</option>
                       <option value="ğŸŒ¨">ë¹„ğŸŒ¨</option>
                       <option value="ğŸŒ©">ë²ˆê°œğŸŒ©</option>
                       <option value="â›…">íë¦¼â›…</option>
                   </select>
                   <!-- ì €ì¥ -->
                   <input type="button" id="submit" class="submit-button" value="ì €ì¥" name="ì œì¶œë²„íŠ¼">
                   <input type="button" id="cancel" value="ì‘ì„± ì·¨ì†Œ">
               </div>
           </div>
       </form>
   </div>

    <script>
        const canvas = document.getElementById("jsCanvas");
        const ctx = canvas.getContext("2d");
        const colors = document.getElementsByClassName("jsColor");
        const range = document.getElementById("jsRange");
        const mode = document.getElementById("jsMode");
        const saveBtn = document.getElementById("jsSave");
        const INITIAL_COLOR = "2c2c2c";
        const CANVAS_SIZE = 600;
        const CANVASH_SIZE = 400;
        canvas.width = CANVAS_SIZE;
        canvas.height = CANVASH_SIZE;
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
        ctx.strokeStyle = INITIAL_COLOR;
        ctx.fillStyle = INITIAL_COLOR;
        ctx.lineWidth = 2.5;

        let painting = false;
        let filling = false;

        function stopPainting() {
            painting = false;
        }

        function startPainting() {
            painting = true;
        }

        function onMouseMove(event) {
            // const x = event.offsetX;
            const x = event.clientX - ctx.canvas.offsetLeft;
            const y = event.clientY - ctx.canvas.offsetTop;
            console.log(x, y);
            if (!painting) {
                //console.log("creating path in" , x ,y);
                ctx.beginPath(); //ê²½ë¡œ ìƒì„±
                ctx.moveTo(x, y); //ì„  ì‹œì‘ ì¢Œí‘œ
            } else {
                //console.log("creating line in" , x ,y);
                ctx.lineTo(x, y); //ì„  ë ì¢Œí‘œ
                ctx.stroke(); //ì„  ê·¸ë¦¬ê¸°
                //ctx.closePath(); //í˜„ëŒ€ë¯¸ìˆ ê°™ì€ ì„ ë“¤..
            }
        }


        function handleColorClick(event) {
            const color = event.target.style.backgroundColor;
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
        }

        function handleRangeChange(event) {
            const size = event.target.value;
            ctx.lineWidth = size;
        }

        function handleModeClick() {
            if (filling === true) {
                filling = false;
                mode.innerText = "FILL";
            } else {
                filling = true;
                mode.innerText = "PAINT"
            }
        }

        function handleCanvasClick() {
            if (filling) {
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            }
        }

        function handleCM(event) {
            event.preventDefault();
        }

        function handleSaveClick() {
            const image = canvas.toDataURL();
            const link = document.createElement("a");
            link.href = image;
            link.download = "PaintJS[ğŸ¨]";
            link.click();
        }

        if (canvas) {
            canvas.addEventListener("mousemove", onMouseMove);
            canvas.addEventListener("mousedown", startPainting);
            canvas.addEventListener("mouseup", stopPainting);
            canvas.addEventListener("mouseleave", stopPainting);
            canvas.addEventListener("click", handleCanvasClick);
            canvas.addEventListener("contextmenu", handleCM)
        }
        Array.from(colors).forEach(color => color.addEventListener("click", handleColorClick));
        if (range) {
            range.addEventListener("input", handleRangeChange);
        }
        if (mode) {
            mode.addEventListener("click", handleModeClick);
        }
        if (saveBtn) {
            saveBtn.addEventListener("click", handleSaveClick);
        }

    </script>
    <script>

       // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ìœ¼ë¡œ í‘œì‹œ, 7ì¼ì „ ì¼ê¸°ê¹Œì§€ ì‘ì„± ê°€ëŠ¥
       let today = new Date()
       let year = today.getFullYear();
       // ì›” getMonth() (0~11ë¡œ 1ì›”ì´ 0ìœ¼ë¡œ í‘œí˜„ë˜ê¸° ë•Œë¬¸ì— + 1ì„ í•´ì£¼ì–´ì•¼ ì›í•˜ëŠ” ì›”ì„ êµ¬í•  ìˆ˜ ìˆë‹¤.)
       let month = today.getMonth() + 1
       // ì¼ getDate()
       let date = today.getDate(); // ì¼
       // console.log(year + '-' + month + '-' + date);

       // ì¼ê¸° ì €ì¥ í´ë¦­
       const submitBtn = document.querySelector('.submit-button');

       const cancel = document.querySelector('#cancel');


        cancel.addEventListener('click', () => {
            alert("ì‘ì„±ì„ ì·¨ì†Œí•˜ì…¨ìŠµë‹ˆë‹¤");
           window.location.href = '/'
        })



       // input ë¹ˆê°’ ì²´í¬
       {#let inputCheck = document.getElementsByClassName("check");#}

       submitBtn.addEventListener('click', () => {

            // ê·¸ë¦¼íŒ ì €ì¥
            const canvas = document.querySelector('#jsCanvas');
            let imgDataUrl = canvas.toDataURL('image/jpeg');

           // ì œëª©
           let title_give = document.querySelector('#title').value;

           // ì„ íƒí•œ ë‚ ì§œ
           let day_give = document.querySelector('#day').value;

           // ì¼ê¸° ë‚´ìš©
           let texts_give = document.querySelector('#texts').value;

           //ë‚ ì”¨
           const weather_give = document.querySelector('#weather');
           let weather = weather_give.options[weather_give.selectedIndex].value;
           // console.log(weather)
           // selectedIndex : ì„ íƒí•œ ìš”ì†Œì˜ ì¸ë±ìŠ¤ë¥¼ ë°˜ì˜
           //í…ŒìŠ¤íŠ¸
           console.log(imgDataUrl,title_give,day_give,texts_give,weather);

            if (imgDataUrl.trim() == "" || day_give.trim() == "" || texts_give.trim() == "" || title_give.trim() == "" ) {
                alert("ì‘ì„±ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”!");
           }else{
                $.ajax({
                    type: "POST",
                    url: "/post",
                    data: {
                        'image': imgDataUrl,
                        'nickname': 'ìœ ì € ë‹‰ë„¤ì„',
                        'title': title_give,
                        'diary_date': day_give,
                        'weather': weather,
                        'texts': texts_give
                    },
                    success: function (response) {
                         alert(response["msg"])
                        window.location.href = '/'
                    }
                })
            }




       })


   </script>

   </body>
</html>